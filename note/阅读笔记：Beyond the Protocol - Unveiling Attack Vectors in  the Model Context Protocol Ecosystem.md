![[../paper/AI safety/2025-Unveiling Attack Vectors in the Model Context Protocol Ecosystem.pdf]]
# Abstract

模型上下文协议（Model Context Protocol, MCP）：让大模型和外界工具进行交互的通信框架，为各种外部工具、API和服务接入大模型提供了一个统一、规范的接口。

从技术上讲，MCP是一个基于HTTP的客户端-服务器（Client-Server）协议。在这个架构中：
- **客户端（Client）**：通常指大型语言模型或基于其构建的AI智能体（Agent）。它负责理解用户意图，并判断何时需要调用外部工具来完成任务。
- **服务器（Server）**：指提供特定功能的外部工具或服务。这可以是任何东西，比如一个天气查询API、一个机票预订系统、一个数据库、甚至另一个专门的AI模型。
- **主机（Host）**：指运行和协调这一切的平台，例如AI应用商店或聚合器（如Poe、Quora等）。主机负责管理工具的发现、用户的权限以及客户端与服务器之间的通信。

本文做了以下工作：
1. 将可能的对MCP服务器的攻击分为了四种， 并构建了恶意MCP服务器，上传到MCP平台上进行实验。
2. 与20名参与者进行访谈，表明用户难以识别恶意MCP服务器。
3. 针对五个领先的 LLM 部署概念验证（PoC）框架，证实了这些攻击能够在用户的本地环境中触发有害行为。
4. 提出MCP 服务器的安全生态系统所面临的四大关键挑战。

# Introduction

MCP工作流程的三个阶段：
1. 注册阶段，服务器向代理描述其功能
2. 规划阶段，代理利用这些描述进行规划
3. 操作阶段，代理向服务器请求工具执行

# Background

## LLM Agents

## Model Context Protocol (MCP)

MCP服务器定义的关键交互要素：
1. Resources
2. Prompts
3. Tools
MCP在被连接时会向主机注册其可用功能，之后根据实际需求决定调用哪些工具。
MCP聚合平台：用户从MCP聚合平台获取MCP服务。

## MCP交互工作流

![[attachments/Pasted image 20250714202820.png]]

1. **初始配置**：MCP客户端根据本地配置从包仓库获取所需的软件包，并启动相应的服务进程。
2. **功能注册**：MCP服务器通过标准化的描述信息注册自身功能，公开可用的工具、资源、提示词等信息。
3. **任务提出**：用户在MCP主机界面输入自然语言指令，例如“帮我在Base网络上向地址0x123……发送1个ETH。”
4. **提示词组装**：MCP客户端将用户的请求与当前会话上下文（包括对话历史、权限状态等）结合起来，提交给LLM进行分析。
5. **工具调用规划**：LLM根据请求的语义以及MCP服务器提供的可用工具目录，制定执行计划，并生成符合MCP协议的调用指令。
6. **工具调用**：MCP客户端将这些指令转换为标准的协议消息，发送给MCP服务器；服务器验证请求后，调用相应的工具。
7. **第三方API调用**：在上述转账场景中，需要调用钱包API对交易进行签名，然后将交易发送至区块链进行确认。
8. **结果返回**：MCP服务器处理从外部服务返回的原始数据，并将结果传递给LLM，由LLM生成最终响应。
9. **响应总结**：LLM将原始请求与服务器返回的数据结合，生成用户易于理解的响应。在转账场景中，模型会明确告知用户转账的结果。

## Prompt注入

## MCP生态系统中的金融操作

# MCP Attack

四类攻击，对应着用户与基于 MCP 的代理之间的九条关键交互路径。

## Threat Model

## Attack Types

### Tool Poisoning Attack

攻击者创建一个看起来正常、功能完整的工具，但这个工具会故意向AI提供虚假的、被篡改的或有害的信息，利用AI对工具的信任，最终欺骗或操纵用户。
![[attachments/Pasted image 20250715112156.png]]
这种攻击主要影响路径②和④，在路径⑥中成功实施，攻击源为 MCP 服务器本身。

### Puppet Attack

恶意工具在返回正常结果的同时，偷偷地在数据中夹带一个“隐藏的指令”（恶意Prompt），这个指令会劫持AI，像幕后黑手一样操纵AI去执行另一个恶意任务，而整个过程用户完全不知情。
![[attachments/Pasted image 20250715152921.png]]
这种攻击主要影响路径②、④和⑤，在路径⑥中成功实施，攻击源为 MCP 服务器本身。

### Rug Pull Attack

恶意服务器最初提供合法、无害的服务，以通过安全审计并获得用户信任。随后，在某个时间点，它会改变其行为（例如，通过更新依赖项或API响应）来发起恶意攻击 。
![[attachments/Pasted image 20250715154619.png]]
该攻击主要影响路径①、②和④，在路径⑥中成功实施，攻击源为 MCP 服务器和包仓库。

### Malicious External Resources

工具本身是无害的，但它所依赖和引用的外部信息源（如网站、数据库、代码库）被攻击者篡改了。于是，这个无辜的工具在不知情的情况下，从被污染的源头获取了有害内容，并将其带回给AI和用户。
![[attachments/Pasted image 20250715160026.png]]
该攻击在路径⑦中成功实施，攻击源为第三方资源。

# Experiment

## Malicious MCP Server Upload Test

### Malicious MCP Server Design
1. MCP 服务器的源代码中植入恶意行为，以评估聚合平台是否会审核代码内容
2. 在项目文档中明确披露该服务器的恶意意图，以测试文档是否会被审核
### Malicious MCP Server Upload
上传到三个MCP聚合平台
### Results
成功上传
### 结论
MCP 聚合平台缺乏严格的审核机制，这使得恶意服务器能够成功上传。

## Simulations For MCP Attacks: A User Study
选择了20名不同身份的人员进行测试，包括：
- 任务 1：盲选。要求参与者选择 MCP 服务器来构建一个旅行规划 AI 代理，且不告知他们存在恶意服务器。该任务旨在考察用户是否会仅根据服务器的描述和表面上的合法性而无意中选择恶意服务器。
- 任务 2：知情识别。在第一个任务之后，告知参与者 13 个服务器中有 4 个是恶意的，并要求他们识别出这些恶意服务器。该任务用于评估他们在有限指导下检测威胁的能力。
- 任务 3：攻击向量分析。在最后一个任务中，我们告知参与者哪些服务器是恶意的，要求他们分析并识别每个恶意服务器所使用的攻击向量。该任务旨在评估他们对威胁机制的理解以及安全推理能力。
### 结论
1. 大多数参与者会无意中选择恶意 MCP 服务器，他们更看重功能而非安全方面的考量。
2. 即便明确告知平台上存在恶意服务器，参与者仍难以对其进行识别。
3. 洞见 4：参与者无法正确识别恶意服务器的全部四种攻击向量，尤其是Rug Pull Attack。

## Attack Implementation

评估此类攻击的可行性，并评估恶意 MCP 服务器对五个广泛使用的大语言模型的影响。

### 结论
- 较高的攻击成功率（ASR）表明，针对主流大语言模型（LLM）服务实施恶意 MCP 服务器攻击具有可行性。
- 大多数大语言模型（LLMs）的低拒绝率（RRs）进一步凸显了识别和抵御来自恶意 MCP 服务器的有害行为存在难度。
- 具备更强工具使用能力的大语言模型（LLMs）往往更容易受到恶意 MCP 服务器的攻击。
- 所有已定义的攻击向量均能在现实场景中有效实施。当前主流的大语言模型（LLMs）缺乏抵御此类攻击的可靠机制。

# Discussion

仍存在的关键问题：
- **用户对MCP安全问题的不熟悉**：用户对于这些新型风险缺乏心智模型。
- **用户对安全警报的麻木和疲劳**：持续的、低信号价值的警告最终会被忽略。
- **安全责任归属模糊**：当攻击成功时，谁应承担责任？是LLM提供商、智能体开发者、聚合平台，还是用户？
- **LLM固有的防御能力缺失**：模型本身缺乏抵御这些架构性攻击的能力。